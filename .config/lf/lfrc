# vi: ft=sh

set shellopts '-eu'
set ifs "\n"
set scrolloff 10
set icons true
set period 1
set info size
set hidden true
set tabstop 4
set dircounts true

set previewer ctpv
set cleaner ctpvclear

&ctpv -s $id

cmd on-quit $ctpv -e $id
cmd setbg "$1"
cmd bulkrename $vimv

cmd mkdir %mkdir -p "$@"
cmd mkfile %touch "$@"
cmd share $curl -F"file=@$fx" https://0x0.st | xclip -selection c

cmd yank-dirname $dirname -- "$f" | head -c-1 | xclip -i -selection clipboard
cmd yank-path $printf '%s' "$fx" | xclip -i -selection clipboard
cmd yank-basename $basename -a -- $fx | head -c-1 | xclip -i -selection clipboard

cmd open ${{
    test -L $f && f=$(readlink -f $f)
    case $(file --mime-type $f -b) in
        text/*) nvim $fx;;
        *) for f in $fx; do xdg-open $f > /dev/null 2> /dev/null & done;;
    esac
}}

cmd unarchive ${{
  case "$f" in
      *.zip) unzip "$f" ;;
      *.tar.gz) tar -xzvf "$f" ;;
      *.tar.bz2) tar -xjvf "$f" ;;
      *.tar) tar -xvf "$f" ;;
      *) echo "Unsupported format" ;;
  esac
}}

cmd paste &{{
    set -- $(cat ~/.local/share/lf/files)
    mode="$1"
    shift
    case "$mode" in
        copy)
            rsync -av --ignore-existing --progress -- "$@" . |
            stdbuf -i0 -o0 -e0 tr '\r' '\n' |
            while IFS= read -r line; do
                lf -remote "send $id echo $line"
            done
            ;;
        move) mv -n -- "$@" .;;
    esac
    rm ~/.local/share/lf/files
    lf -remote "send clear"
}}

cmd paste-async &{{
    set -- $(cat ~/.local/share/lf/files)
    mode="$1"
    shift
    case "$mode" in
        copy) cp -rn -- "$@" .;;
        move) mv -n -- "$@" .;;
    esac
    rm ~/.local/share/lf/files
    lf -remote "send clear"
}}

# Bindings
map <c-f> $lf -remote "send $id select '$(fzf)'"
map C clear
map <enter> shell

map d
map dD delete
map dd cut
map dt trash

map y
map yy copy
map yp yank-path
map yd yank-dirname
map yn yank-basename

# rename
map A rename
map c push A<c-u>
map I push A<c-a>
map i push A<a-b><a-b><a-f>
map a push A<a-b>
map B bulkrename

map gdt cd /mnt/Seagate/Code/dotfiles
map gwa cd /mnt/Seagate/wallpapers
map gsc cd /mnt/Seagate/screenshot
map gsy cd /mnt/Seagate/syncthing
map gco cd /mnt/Seagate/Code
map gex cd /mnt/Seagate
map gls cd ~/.local/src
map gdo cd ~/Downloads
map gcn cd ~/.config
map gll cd ~/.local

map mk push :mkdir<space>
map mf push :mkfile<space>

map ua unarchive
map bg $setbg $f

map W $setsid -f $TERMINAL >/dev/null 2>&1
map V push :!nvim<space>
map E unarchive
map S share

# cmd mode mappings
cmap <up>   cmd-history-prev
cmap <down> cmd-history-next
